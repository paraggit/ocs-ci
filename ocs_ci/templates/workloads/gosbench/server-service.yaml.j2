apiVersion: v1
kind: Service
metadata:
  name: {{ service_name }}
  namespace: {{ namespace }}
  labels:
    app: {{ server_name }}
    component: gosbench-server
    workload: {{ workload_name | default("gosbench") }}
    version: {{ version | default("latest") }}
{% if custom_labels %}
{%- for key, value in custom_labels.items() %}
    {{ key }}: {{ value }}
{%- endfor %}
{% endif %}
{% if annotations %}
  annotations:
{%- for key, value in annotations.items() %}
    {{ key }}: {{ value }}
{%- endfor %}
{% endif %}
spec:
  selector:
    app: {{ server_name }}
  ports:
    - name: control
      port: {{ control_port | default(2000) }}
      targetPort: {{ control_port | default(2000) }}
      protocol: TCP
{% if control_node_port %}
      nodePort: {{ control_node_port }}
{% endif %}
    - name: metrics
      port: {{ metrics_port | default(2112) }}
      targetPort: {{ metrics_port | default(2112) }}
      protocol: TCP
{% if metrics_node_port %}
      nodePort: {{ metrics_node_port }}
{% endif %}
{% if extra_ports %}
{%- for port in extra_ports %}
    - name: {{ port.name }}
      port: {{ port.port }}
      targetPort: {{ port.targetPort | default(port.port) }}
      protocol: {{ port.protocol | default("TCP") }}
{% if port.nodePort %}
      nodePort: {{ port.nodePort }}
{% endif %}
{%- endfor %}
{% endif %}
  type: {{ service_type | default("ClusterIP") }}
{% if session_affinity %}
  sessionAffinity: {{ session_affinity }}
{% endif %}
{% if session_affinity_config %}
  sessionAffinityConfig:
{{ session_affinity_config | to_nice_yaml | indent(4, True) }}
{% endif %}
{% if external_traffic_policy %}
  externalTrafficPolicy: {{ external_traffic_policy }}
{% endif %}
{% if load_balancer_ip %}
  loadBalancerIP: {{ load_balancer_ip }}
{% endif %}
{% if load_balancer_source_ranges %}
  loadBalancerSourceRanges:
{%- for range in load_balancer_source_ranges %}
    - {{ range }}
{%- endfor %}
{% endif %}
{% if external_ips %}
  externalIPs:
{%- for ip in external_ips %}
    - {{ ip }}
{%- endfor %}
{% endif %}
